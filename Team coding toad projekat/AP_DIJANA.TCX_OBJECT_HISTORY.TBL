DROP TABLE AP_DIJANA.TCX_OBJECT_HISTORY CASCADE CONSTRAINTS;

CREATE TABLE AP_DIJANA.TCX_OBJECT_HISTORY
(
  CONFIG_ID              INTEGER                NOT NULL,
  PROJECT_ID             INTEGER                NOT NULL,
  OBJECT_ID              INTEGER                NOT NULL,
  TRANSACTION_ID         INTEGER                NOT NULL,
  TRANSACTION_TYPE       VARCHAR2(30 BYTE)      NOT NULL,
  TC_ACTION              VARCHAR2(30 BYTE)      NOT NULL,
  TC_REVISION            VARCHAR2(30 BYTE)      NOT NULL,
  VCS_REVISION           VARCHAR2(30 BYTE),
  VCS_PROVIDER           VARCHAR2(255 BYTE),
  VCPID                  INTEGER,
  VCS_PROJECT            VARCHAR2(2000 BYTE),
  DB_USER                VARCHAR2(128 BYTE),
  VCS_USER               VARCHAR2(128 BYTE),
  OS_USER                VARCHAR2(128 BYTE),
  CHECKOUT_TIMESTAMP     DATE,
  CHECKIN_TIMESTAMP      DATE,
  TRANSACTION_TIMESTAMP  DATE                   NOT NULL,
  CX_RUNNAME             VARCHAR2(100 BYTE),
  COMPLETED              CHAR(1 BYTE)           DEFAULT 'N'                   NOT NULL,
  COMMENTS               VARCHAR2(255 BYTE),
  SYS_COMMENTS           VARCHAR2(255 BYTE)
)
TABLESPACE USERS
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE;


CREATE UNIQUE INDEX AP_DIJANA.TCX_OBJECT_HIST_PK ON AP_DIJANA.TCX_OBJECT_HISTORY
(CONFIG_ID, PROJECT_ID, OBJECT_ID, TRANSACTION_ID)
LOGGING
TABLESPACE USERS
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           );

ALTER TABLE AP_DIJANA.TCX_OBJECT_HISTORY ADD (
  CHECK ( COMPLETED IN ('Y','N'))
  ENABLE VALIDATE
,  CONSTRAINT TCX_OBJECT_HIST_PK
  PRIMARY KEY
  (CONFIG_ID, PROJECT_ID, OBJECT_ID, TRANSACTION_ID)
  USING INDEX AP_DIJANA.TCX_OBJECT_HIST_PK
  ENABLE VALIDATE);


CREATE OR REPLACE TRIGGER AP_DIJANA.TCX_OBJECT_HISTORY_TRG
BEFORE INSERT
ON AP_DIJANA.TCX_OBJECT_HISTORY
REFERENCING NEW AS New OLD AS Old
FOR EACH ROW
DECLARE
  N NUMBER;
BEGIN
-- For Toad:  Highlight column TRANSACTION_ID
  Select AP_DIJANA.TCX_OBJECT_HISTORY_SEQ.nextval into n from dual;
  :new.TRANSACTION_ID := N;
END TCX_OBJECT_HISTORY_TRG;
/


ALTER TABLE AP_DIJANA.TCX_OBJECT_HISTORY ADD (
  CONSTRAINT TCX_OBJHIST_OBJ_PROJ_FK 
  FOREIGN KEY (CONFIG_ID, PROJECT_ID, OBJECT_ID) 
  REFERENCES AP_DIJANA.TCX_OBJECTS (CONFIG_ID, PROJECT_ID, OBJECT_ID)
  ENABLE VALIDATE);

GRANT DELETE, INSERT, SELECT, UPDATE ON AP_DIJANA.TCX_OBJECT_HISTORY TO PUBLIC;

GRANT DELETE, INSERT, SELECT, UPDATE ON AP_DIJANA.TCX_OBJECT_HISTORY TO TC_ADMIN_ROLE;
